{% extends "base.html" %}

{% block title %}Performance - MeTruyenCV Downloader{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-speedometer2 me-2 text-primary"></i>
        Performance Monitor
    </h1>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="refreshStats()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Refresh
        </button>
        <button class="btn btn-outline-warning" onclick="clearCache()">
            <i class="bi bi-trash me-1"></i>
            Clear Cache
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
            <i class="bi bi-house me-1"></i>
            Dashboard
        </a>
    </div>
</div>

<!-- Performance Stats -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-clock text-info fs-1 me-2"></i>
                    <div>
                        <h5 class="card-title mb-0">Response Time</h5>
                        <p class="card-text mb-0">
                            <span id="avg-response-time">--</span>s
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-exclamation-triangle text-warning fs-1 me-2"></i>
                    <div>
                        <h5 class="card-title mb-0">Error Rate</h5>
                        <p class="card-text mb-0">
                            <span id="error-rate">--</span>%
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-graph-up text-success fs-1 me-2"></i>
                    <div>
                        <h5 class="card-title mb-0">Total Requests</h5>
                        <p class="card-text mb-0">
                            <span id="total-requests">--</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <i class="bi bi-hdd text-primary fs-1 me-2"></i>
                    <div>
                        <h5 class="card-title mb-0">Cache Size</h5>
                        <p class="card-text mb-0">
                            <span id="cache-size">--</span> items
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Stats -->
<div class="row mb-4" id="system-stats" style="display: none;">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-cpu me-1"></i>
                    CPU Usage
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-2">
                    <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center">
                    <span id="cpu-percent">0</span>%
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-memory me-1"></i>
                    Memory Usage
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-2">
                    <div id="memory-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center">
                    <span id="memory-percent">0</span>%
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-hdd-stack me-1"></i>
                    Disk Usage
                </h6>
            </div>
            <div class="card-body">
                <div class="progress mb-2">
                    <div id="disk-progress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="text-center">
                    <span id="disk-percent">0</span>%
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cache Details -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-hdd me-2"></i>
                    Cache Details
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="cache-table">
                            <tr>
                                <td colspan="3" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-activity me-2"></i>
                    Download Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Status:</small><br>
                        <span id="download-status" class="badge bg-secondary">Unknown</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Progress:</small><br>
                        <span id="download-progress">0%</span>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Current Chapter:</small><br>
                        <span id="current-chapter">0</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Total Chapters:</small><br>
                        <span id="total-chapters">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Chart -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-graph-up me-2"></i>
            Performance Trends
        </h5>
    </div>
    <div class="card-body">
        <canvas id="performance-chart" width="400" height="200"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let performanceChart;
let chartData = {
    labels: [],
    datasets: [{
        label: 'Response Time (s)',
        data: [],
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1
    }]
};

// Initialize chart
function initChart() {
    const ctx = document.getElementById('performance-chart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Response Time (seconds)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Time'
                    }
                }
            }
        }
    });
}

function refreshStats() {
    fetch('/api/performance')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                updateUI(result.data);
            } else {
                showToast('Lỗi tải performance stats: ' + result.message, 'danger');
            }
        })
        .catch(error => {
            showToast('Lỗi kết nối: ' + error.message, 'danger');
        });
}

function updateUI(data) {
    // Performance stats
    const perf = data.performance;
    document.getElementById('avg-response-time').textContent = perf.avg_response_time || '--';
    document.getElementById('error-rate').textContent = perf.error_rate || '--';
    document.getElementById('total-requests').textContent = perf.total_requests || '--';
    
    // Cache stats
    const cache = data.cache;
    document.getElementById('cache-size').textContent = cache.cache_size || 0;
    
    // Update cache table
    const cacheTable = document.getElementById('cache-table');
    if (cache.cache_keys && cache.cache_keys.length > 0) {
        cacheTable.innerHTML = cache.cache_keys.map(key => `
            <tr>
                <td>${key}</td>
                <td><span class="badge bg-success">Cached</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCacheKey('${key}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    } else {
        cacheTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No cache entries</td></tr>';
    }
    
    // System stats (if available)
    if (data.system) {
        document.getElementById('system-stats').style.display = 'block';
        
        const cpu = data.system.cpu_percent;
        const memory = data.system.memory_percent;
        const disk = data.system.disk_usage;
        
        document.getElementById('cpu-percent').textContent = cpu.toFixed(1);
        document.getElementById('cpu-progress').style.width = cpu + '%';
        
        document.getElementById('memory-percent').textContent = memory.toFixed(1);
        document.getElementById('memory-progress').style.width = memory + '%';
        
        document.getElementById('disk-percent').textContent = disk.toFixed(1);
        document.getElementById('disk-progress').style.width = disk + '%';
    }
    
    // Download status
    const download = data.download_status;
    document.getElementById('download-status').textContent = download.status_message;
    document.getElementById('download-status').className = 'badge ' + 
        (download.is_downloading ? 'bg-warning' : 'bg-secondary');
    document.getElementById('download-progress').textContent = download.progress + '%';
    document.getElementById('current-chapter').textContent = download.current_chapter;
    document.getElementById('total-chapters').textContent = download.total_chapters;
    
    // Update chart
    updateChart(perf.avg_response_time);
}

function updateChart(responseTime) {
    const now = new Date().toLocaleTimeString();
    
    chartData.labels.push(now);
    chartData.datasets[0].data.push(responseTime);
    
    // Keep only last 20 data points
    if (chartData.labels.length > 20) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
    }
    
    performanceChart.update();
}

function clearCache() {
    if (confirm('Bạn có chắc muốn xóa toàn bộ cache?')) {
        fetch('/api/cache/clear', { method: 'POST' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(result.message, 'success');
                    refreshStats();
                } else {
                    showToast('Lỗi: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                showToast('Lỗi kết nối: ' + error.message, 'danger');
            });
    }
}

function deleteCacheKey(key) {
    // This would need a specific API endpoint
    showToast('Tính năng xóa cache key riêng lẻ chưa được implement', 'info');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    refreshStats();
    
    // Auto refresh every 5 seconds
    setInterval(refreshStats, 5000);
});
</script>
{% endblock %}
